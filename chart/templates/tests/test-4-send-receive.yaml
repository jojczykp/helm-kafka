apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "chart.fullname" . }}-test-send-receive"
  labels:
    {{- include "kafka.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: test
      image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
      command: ["bash", "-c"]
      args:
        - |
          set -e

          TOPIC="{{ first .Values.topics }}"
          SENT="Smog Wawelski ${RANDOM}"

          echo "${SENT}" | \
              /opt/kafka/bin/kafka-console-producer.sh \
                  --bootstrap-server {{ .Values.service.name }}:{{ .Values.service.port }} \
                  --topic "${TOPIC}"

          RECEIVED=$(\
              /opt/kafka/bin/kafka-console-consumer.sh \
                  --bootstrap-server {{ .Values.service.name }}:{{ .Values.service.port }} \
                  --topic "${TOPIC}" \
                  --from-beginning \
                  --timeout-ms 1000 \
                    | grep "${SENT}" \
              )

          echo "Sent:     '${SENT}'"
          echo "Received: '${RECEIVED}'"

          [ "${SENT}" = "${RECEIVED}" ]

  restartPolicy: Never
