apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "chart.fullname" . }}-test-topics-created"
  labels:
    {{- include "kafka.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: test
      image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
      command: ["bash", "-c"]
      args:
        - |
          set -e

          ACTUAL_TOPICS=$(/opt/kafka/bin/kafka-topics.sh \
                          --bootstrap-server {{ .Values.service.name }}:{{ .Values.service.port }} \
                          --list \
                              | grep -v __consumer_offsets \
                              | sort \
                              | paste -s -d ' ' \
                          )

          EXPECTED_TOPICS="{{ .Values.topics | sortAlpha | join " " }}"

          echo "Actual topics:   '${ACTUAL_TOPICS}'"
          echo "Expected topics: '${EXPECTED_TOPICS}'"

          [ "${ACTUAL_TOPICS}" = "${EXPECTED_TOPICS}" ]

  restartPolicy: Never
